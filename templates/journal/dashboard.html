{% extends "base.html" %}

{% block title %}dashboard - dondont{% endblock %}

{% block extra_head %}
<style>
    .contribution-graph {
        display: flex;
        gap: 5px;
    }
    .contribution-column {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    .contribution-cell {
        width: 18px;
        height: 18px;
        border-radius: 2px;
        cursor: pointer;
    }
    .contribution-cell:hover {
        outline: 1px solid rgba(0, 0, 0, 0.3);
        outline-offset: 1px;
    }
    .month-labels {
        display: flex;
        gap: 5px;
        margin-bottom: 8px;
    }
    .month-label {
        font-size: 14px;
        color: #666;
    }
    .day-labels {
        display: flex;
        flex-direction: column;
        gap: 5px;
        margin-right: 12px;
        padding-top: 28px;
    }
    .day-label {
        height: 18px;
        font-size: 14px;
        color: #666;
        display: flex;
        align-items: center;
    }
    #contribution-graph-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style>
{% endblock %}

{% block content %}
<!-- GitHub-Style Contribution Graph -->
<div class="bg-white rounded-lg shadow-md p-8">
    <h2 class="text-xl font-semibold text-gray-800 mb-2 lowercase"><span id="current-year"></span></h2>
    
    <div id="contribution-graph-container">
        <div id="contribution-graph">
            <!-- Graph will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Legend -->
    <div class="mt-6 flex items-center justify-end space-x-2 text-sm text-gray-600">
        <span class="lowercase">less</span>
        <div class="contribution-cell" style="background-color: #ebedf0;"></div>
        <div class="contribution-cell" style="background-color: #9be9a8;"></div>
        <div class="contribution-cell" style="background-color: #40c463;"></div>
        <div class="contribution-cell" style="background-color: #30a14e;"></div>
        <div class="contribution-cell" style="background-color: #216e39;"></div>
        <span class="lowercase">more</span>
    </div>
</div>

<script>
// Calendar data from Django
const calendarData = {{ calendar_data|safe }};

function generateContributionGraph() {
    const graphContainer = document.getElementById('contribution-graph');
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Reset to start of day
    
    // Update year display
    document.getElementById('current-year').textContent = today.getFullYear();
    
    // Start from January 1 of current year
    const startDate = new Date(today.getFullYear(), 0, 1);
    startDate.setHours(0, 0, 0, 0);
    
    // Adjust to start on the Sunday before or on Jan 1
    const dayOfWeek = startDate.getDay(); // 0 = Sunday
    if (dayOfWeek !== 0) {
        startDate.setDate(startDate.getDate() - dayOfWeek);
    }
    
    // Create data map
    const dataMap = {};
    calendarData.forEach(day => {
        dataMap[day.date] = day;
    });
    
    // Generate weeks - each week is a column
    const weeks = [];
    let currentDate = new Date(startDate);
    
    while (currentDate <= today) {
        const week = [];
        for (let i = 0; i < 7; i++) {
            if (currentDate > today) {
                // Don't add cells beyond today
                break;
            }
            const dateStr = currentDate.toISOString().split('T')[0];
            const dayData = dataMap[dateStr] || { date: dateStr, total: 0, completed: 0, percentage: 0 };
            
            week.push({
                date: new Date(currentDate),
                dateStr: dateStr,
                data: dayData,
                dayOfWeek: currentDate.getDay()
            });
            currentDate.setDate(currentDate.getDate() + 1);
        }
        if (week.length > 0) {
            weeks.push(week);
        }
    }
    
    // Build HTML
    let html = '<div style="display: flex;">';
    
    // Day labels (Sun = 0, Mon = 1, ..., Sat = 6)
    html += '<div class="day-labels">';
    html += '<div class="day-label" style="visibility: hidden;">sun</div>';
    html += '<div class="day-label">mon</div>';
    html += '<div class="day-label" style="visibility: hidden;">tue</div>';
    html += '<div class="day-label">wed</div>';
    html += '<div class="day-label" style="visibility: hidden;">thu</div>';
    html += '<div class="day-label">fri</div>';
    html += '<div class="day-label" style="visibility: hidden;">sat</div>';
    html += '</div>';
    
    html += '<div>';
    
    // Month labels - show month name at the start of each month
    html += '<div class="month-labels">';
    let lastLabeledMonth = -1;
    
    weeks.forEach((week, weekIndex) => {
        if (week.length === 0) {
            html += `<div class="month-label" style="width: 23px;"></div>`;
            return;
        }
        
        // Find the dominant month in this week (most days)
        const monthCounts = {};
        week.forEach(day => {
            const monthKey = `${day.date.getFullYear()}-${day.date.getMonth()}`;
            monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
        });
        
        // Get month with most days
        let dominantMonthKey = Object.keys(monthCounts).reduce((a, b) => 
            monthCounts[a] > monthCounts[b] ? a : b
        );
        const [year, month] = dominantMonthKey.split('-').map(Number);
        const dominantMonthInt = year * 12 + month;
        
        // Show label if this is a new month
        if (dominantMonthInt !== lastLabeledMonth) {
            const monthName = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'short' }).toLowerCase();
            html += `<div class="month-label">${monthName}</div>`;
            lastLabeledMonth = dominantMonthInt;
        } else {
            // Empty placeholder
            html += `<div class="month-label" style="width: 23px;"></div>`;
        }
    });
    html += '</div>';
    
    // Contribution cells
    html += '<div class="contribution-graph">';
    weeks.forEach(week => {
        html += '<div class="contribution-column">';
        // Fill empty cells at the start if week doesn't start on Sunday
        if (week.length > 0) {
            const firstDayOfWeek = week[0].dayOfWeek;
            for (let i = 0; i < firstDayOfWeek; i++) {
                if (week === weeks[0]) {
                    html += '<div class="contribution-cell" style="background-color: transparent; border: none;"></div>';
                }
            }
        }
        week.forEach(day => {
            const color = getContributionColor(day.data.percentage, day.data.total);
            const dateFormatted = day.date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const tooltip = `${day.data.completed}/${day.data.total} on ${dateFormatted}`;
            html += `<a href="/journal/${day.dateStr}/" class="contribution-cell" style="background-color: ${color};" title="${tooltip}"></a>`;
        });
        // Fill empty cells at the end if week doesn't end on Saturday
        if (week.length > 0 && week === weeks[weeks.length - 1]) {
            const lastDayOfWeek = week[week.length - 1].dayOfWeek;
            for (let i = lastDayOfWeek; i < 6; i++) {
                html += '<div class="contribution-cell" style="background-color: transparent; border: none;"></div>';
            }
        }
        html += '</div>';
    });
    html += '</div>';
    
    html += '</div></div>';
    
    graphContainer.innerHTML = html;
}

function getContributionColor(percentage, total) {
    if (total === 0) return '#ebedf0';
    if (percentage === 0) return '#ebedf0';
    if (percentage <= 25) return '#9be9a8';
    if (percentage <= 50) return '#40c463';
    if (percentage <= 75) return '#30a14e';
    return '#216e39';
}

// Generate graph on page load
generateContributionGraph();

// Scroll to show today (right side of the graph)
const container = document.getElementById('contribution-graph-container');
if (container) {
    // Wait a bit for the graph to render, then scroll to the right
    setTimeout(() => {
        container.scrollLeft = container.scrollWidth - container.clientWidth;
    }, 100);
}
</script>

{% endblock %}

