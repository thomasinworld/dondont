{% extends "base.html" %}

{% block title %}journal for {{ date|date:"F j, Y" }} - dondont{% endblock %}

{% block content %}
<!-- Header with Date Navigation -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="flex items-center justify-between mb-4">
        <a href="{% url 'journal:daily_journal' prev_date|date:'Y-m-d' %}" 
           class="text-green-600 hover:text-green-800 font-medium flex items-center lowercase">
            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            previous day
        </a>
        
        <h1 class="text-3xl font-bold text-gray-900 lowercase">
            {{ date|date:"F j, Y" }}
            {% if is_today %}
            <span class="text-green-600 text-lg ml-2">(today)</span>
            {% endif %}
        </h1>
        
        {% if not is_today %}
        <a href="{% url 'journal:daily_journal' next_date|date:'Y-m-d' %}" 
           class="text-green-600 hover:text-green-800 font-medium flex items-center lowercase">
            next day
            <svg class="w-5 h-5 ml-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
        </a>
        {% else %}
        <div class="w-32"></div>
        {% endif %}
    </div>
    
    <!-- Progress Bar -->
    <div class="mt-4">
        <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium text-gray-700 lowercase">daily progress</span>
            <span class="text-2xl font-bold text-green-600" id="percentage">{{ percentage }}%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
            <div class="h-full bg-gradient-to-r from-green-400 to-green-600 rounded-full transition-all duration-500"
                 id="progress-bar"
                 style="width: {{ percentage }}%">
            </div>
        </div>
        <p class="text-sm text-gray-600 mt-2 text-center lowercase">
            <span id="completed-count">{{ completed }}</span> of <span id="total-count">{{ total }}</span> completed
        </p>
    </div>
</div>

<!-- Do's Section -->
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <h2 class="text-2xl font-bold text-green-600 mb-4 flex items-center lowercase">
        <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
        to do
    </h2>
    <div class="space-y-3">
        {% for item in entries_do %}
        <div class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <input type="checkbox" 
                   class="checkbox-custom w-6 h-6 text-green-600 rounded focus:ring-green-500 cursor-pointer"
                   data-entry-id="{{ item.entry.id }}"
                   {% if item.entry.completed %}checked{% endif %}
                   onchange="toggleEntry(this)">
            <label class="ml-4 flex-1 text-lg text-gray-800 cursor-pointer" onclick="this.previousElementSibling.click()">
                {{ item.dodont.text }}
            </label>
            <div class="flex items-center space-x-2">
                {% if item.streak > 0 %}
                <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center"
                      data-streak-id="{{ item.entry.id }}">
                    ðŸ”¥ {{ item.streak }} day{{ item.streak|pluralize }}
                </span>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-gray-500 text-center py-4 lowercase">no "do" items yet. <a href="{% url 'journal:manage_dodonts' %}" class="text-green-600 hover:underline">add some!</a></p>
        {% endfor %}
    </div>
</div>

<!-- Don'ts Section -->
<div class="bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-bold text-red-600 mb-4 flex items-center lowercase">
        <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
        </svg>
        to don't
    </h2>
    <div class="space-y-3">
        {% for item in entries_dont %}
        <div class="flex items-center p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
            <input type="checkbox" 
                   class="checkbox-custom w-6 h-6 text-red-600 rounded focus:ring-red-500 cursor-pointer"
                   data-entry-id="{{ item.entry.id }}"
                   {% if item.entry.completed %}checked{% endif %}
                   onchange="toggleEntry(this)">
            <label class="ml-4 flex-1 text-lg text-gray-800 cursor-pointer" onclick="this.previousElementSibling.click()">
                {{ item.dodont.text }}
            </label>
            <div class="flex items-center space-x-2">
                {% if item.streak > 0 %}
                <span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center"
                      data-streak-id="{{ item.entry.id }}">
                    ðŸ”¥ {{ item.streak }} day{{ item.streak|pluralize }}
                </span>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <p class="text-gray-500 text-center py-4 lowercase">no "don't" items yet. <a href="{% url 'journal:manage_dodonts' %}" class="text-green-600 hover:underline">add some!</a></p>
        {% endfor %}
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleEntry(checkbox) {
    const entryId = checkbox.dataset.entryId;
    const csrftoken = getCookie('csrftoken');
    
    fetch("{% url 'journal:toggle_entry' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ entry_id: entryId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update progress bar
            document.getElementById('percentage').textContent = data.percentage + '%';
            document.getElementById('progress-bar').style.width = data.percentage + '%';
            
            // Update completed count
            const completedCount = document.querySelectorAll('input[type="checkbox"]:checked').length;
            document.getElementById('completed-count').textContent = completedCount;
            
            // Update streak
            const streakBadge = document.querySelector(`[data-streak-id="${entryId}"]`);
            if (data.streak > 0) {
                if (streakBadge) {
                    streakBadge.textContent = `ðŸ”¥ ${data.streak} day${data.streak > 1 ? 's' : ''}`;
                } else {
                    // Create new streak badge if it doesn't exist
                    const badge = document.createElement('span');
                    badge.className = 'bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-semibold flex items-center';
                    badge.dataset.streakId = entryId;
                    badge.textContent = `ðŸ”¥ ${data.streak} day${data.streak > 1 ? 's' : ''}`;
                    checkbox.parentElement.querySelector('.flex.items-center.space-x-2').appendChild(badge);
                }
            } else if (streakBadge) {
                streakBadge.remove();
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        checkbox.checked = !checkbox.checked; // Revert on error
    });
}
</script>
{% endblock %}

