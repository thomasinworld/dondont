{% extends "base.html" %}

{% block title %}manage habits - dondont{% endblock %}

{% block content %}
<div class="grid md:grid-cols-2 gap-8">
    <!-- Do's Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-green-600 mb-4 flex items-center lowercase">
            <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            things to do
        </h2>
        
        <!-- Add New Do Form -->
        <div class="mb-6">
            <div class="flex space-x-2">
                <input type="text" 
                       id="new-do-input"
                       placeholder="add a new 'do' item..."
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                       onkeypress="if(event.key === 'Enter') addDoDont('do')">
                <button onclick="addDoDont('do')"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium transition lowercase">
                    add
                </button>
            </div>
        </div>
        
        <!-- List of Do's -->
        <div id="do-list" class="space-y-2">
            {% for dodont in dodonts_do %}
            <div class="flex items-center p-3 bg-gray-50 rounded-lg group hover:bg-gray-100 transition"
                 data-dodont-id="{{ dodont.id }}">
                <span class="flex-1 text-gray-800" id="text-{{ dodont.id }}">{{ dodont.text }}</span>
                <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editDoDont({{ dodont.id }})"
                            class="text-blue-600 hover:text-blue-800 p-1">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                        </svg>
                    </button>
                    <button onclick="deleteDoDont({{ dodont.id }})"
                            class="text-red-600 hover:text-red-800 p-1">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
            {% if not dodonts_do %}
            <p class="text-gray-500 text-center py-8 lowercase">no "do" items yet. add your first one above!</p>
            {% endif %}
        </div>
    </div>

    <!-- Don'ts Section -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-2xl font-bold text-red-600 mb-4 flex items-center lowercase">
            <svg class="w-7 h-7 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
            </svg>
            things to avoid
        </h2>
        
        <!-- Add New Don't Form -->
        <div class="mb-6">
            <div class="flex space-x-2">
                <input type="text" 
                       id="new-dont-input"
                       placeholder="add a new 'don't' item..."
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"
                       onkeypress="if(event.key === 'Enter') addDoDont('dont')">
                <button onclick="addDoDont('dont')"
                        class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg font-medium transition lowercase">
                    add
                </button>
            </div>
        </div>
        
        <!-- List of Don'ts -->
        <div id="dont-list" class="space-y-2">
            {% for dodont in dodonts_dont %}
            <div class="flex items-center p-3 bg-gray-50 rounded-lg group hover:bg-gray-100 transition"
                 data-dodont-id="{{ dodont.id }}">
                <span class="flex-1 text-gray-800" id="text-{{ dodont.id }}">{{ dodont.text }}</span>
                <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editDoDont({{ dodont.id }})"
                            class="text-blue-600 hover:text-blue-800 p-1">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                        </svg>
                    </button>
                    <button onclick="deleteDoDont({{ dodont.id }})"
                            class="text-red-600 hover:text-red-800 p-1">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            </div>
            {% endfor %}
            {% if not dodonts_dont %}
            <p class="text-gray-500 text-center py-8 lowercase">no "don't" items yet. add your first one above!</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function addDoDont(itemType) {
    const inputId = itemType === 'do' ? 'new-do-input' : 'new-dont-input';
    const input = document.getElementById(inputId);
    const text = input.value.trim();
    
    if (!text) return;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch("{% url 'journal:add_dodont' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ text: text, item_type: itemType })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Clear input
            input.value = '';
            
            // Add new item to the DOM dynamically
            const listId = itemType === 'do' ? 'do-list' : 'dont-list';
            const list = document.getElementById(listId);
            
            // Remove "no items" message if it exists
            const emptyMessage = list.querySelector('.text-gray-500');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            // Escape HTML to prevent XSS
            const escapedText = data.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // Create new item element
            const newItem = document.createElement('div');
            newItem.className = 'flex items-center p-3 bg-gray-50 rounded-lg group hover:bg-gray-100 transition';
            newItem.setAttribute('data-dodont-id', data.id);
            newItem.innerHTML = `
                <span class="flex-1 text-gray-800" id="text-${data.id}">${escapedText}</span>
                <div class="flex space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="editDoDont(${data.id})"
                            class="text-blue-600 hover:text-blue-800 p-1">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                        </svg>
                    </button>
                    <button onclick="deleteDoDont(${data.id})"
                            class="text-red-600 hover:text-red-800 p-1">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                    </button>
                </div>
            `;
            list.appendChild(newItem);
        } else {
            alert('Failed to add item: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Failed to add item. Please try again.');
    });
}

function deleteDoDont(dodontId) {
    if (!confirm('Are you sure you want to delete this item?')) return;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/api/delete-dodont/${dodontId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelector(`[data-dodont-id="${dodontId}"]`).remove();
        }
    })
    .catch(error => console.error('Error:', error));
}

function editDoDont(dodontId) {
    const textElement = document.getElementById(`text-${dodontId}`);
    const currentText = textElement.textContent;
    const newText = prompt('Edit item:', currentText);
    
    if (!newText || newText === currentText) return;
    
    const csrftoken = getCookie('csrftoken');
    
    fetch(`/api/update-dodont/${dodontId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({ text: newText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            textElement.textContent = data.text;
        }
    })
    .catch(error => console.error('Error:', error));
}
</script>
{% endblock %}

